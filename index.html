// Show capture animation
                const viewfinder = document.querySelector('.viewfinder');
                if (viewfinder) {
                    viewfinder.style.transition = 'opacity 0.1s';
                    viewfinder.style.opacity = '0.5';
                    setTimeout(() => {
                        viewfinder.style.opacity = '1';
                    }, 100);
                }
                
                // Optionally navigate to gallery or drawing
                setTimeout(() => {
                    if (confirm('Great photo! Do you want to draw on it?')) {
                        this.navigateToScreen('drawing');
                    }
                }, 300);
            },
            
            // Drawing Screen
            renderDrawingScreen() {
                const mainContent = document.getElementById('main-content');
                
                const drawingContainer = document.createElement('div');
                drawingContainer.className = 'drawing-container';
                
                const title = document.createElement('h2');
                title.textContent = 'Drawing Studio';
                title.style.color = '#805AD5';
                title.style.fontSize = '20px';
                
                // Create canvas for drawing
                const canvasContainer = document.createElement('div');
                canvasContainer.style.width = '100%';
                
                const canvas = document.createElement('canvas');
                canvas.id = 'drawing-canvas';
                canvas.width = 800;
                canvas.height = 800;
                
                canvasContainer.appendChild(canvas);
                
                // Color palette
                const colorPalette = document.createElement('div');
                colorPalette.className = 'color-palette';
                
                this.colors.forEach((colorObj, index) => {
                    const colorButton = document.createElement('button');
                    colorButton.className = `color-button ${colorObj.active ? 'active' : ''}`;
                    colorButton.style.backgroundColor = colorObj.color;
                    colorButton.dataset.color = colorObj.color;
                    colorButton.addEventListener('click', () => this.selectColor(index));
                    colorPalette.appendChild(colorButton);
                });
                
                // Drawing tools
                const drawingTools = document.createElement('div');
                drawingTools.className = 'drawing-tools';
                
                this.tools.forEach((tool, index) => {
                    const toolButton = document.createElement('button');
                    toolButton.className = `tool-button ${tool.active ? 'active' : ''}`;
                    toolButton.textContent = tool.icon;
                    toolButton.dataset.tool = tool.id;
                    toolButton.addEventListener('click', () => this.selectTool(index));
                    drawingTools.appendChild(toolButton);
                });
                
                // Templates row
                const templatesRow = document.createElement('div');
                templatesRow.className = 'templates-row';
                
                this.templates.forEach(template => {
                    const templateItem = document.createElement('div');
                    templateItem.className = 'template-item';
                    
                    const templateIcon = document.createElement('div');
                    templateIcon.className = 'template-icon';
                    templateIcon.textContent = template.icon;
                    
                    const templateLabel = document.createElement('div');
                    templateLabel.className = 'template-label';
                    templateLabel.textContent = template.label;
                    
                    templateItem.appendChild(templateIcon);
                    templateItem.appendChild(templateLabel);
                    templateItem.addEventListener('click', () => this.addTemplate(template));
                    
                    templatesRow.appendChild(templateItem);
                });
                
                // Clear and Save buttons
                const actionButtons = document.createElement('div');
                actionButtons.className = 'action-buttons';
                
                const clearButton = document.createElement('button');
                clearButton.className = 'action-button';
                clearButton.innerHTML = 'ðŸ—‘ï¸ Clear';
                clearButton.addEventListener('click', () => this.clearCanvas());
                
                const saveButton = document.createElement('button');
                saveButton.className = 'action-button';
                saveButton.innerHTML = 'ðŸ’¾ Save';
                saveButton.addEventListener('click', () => this.saveDrawing());
                
                actionButtons.appendChild(clearButton);
                actionButtons.appendChild(saveButton);
                
                // Add all elements to container
                drawingContainer.appendChild(title);
                drawingContainer.appendChild(canvasContainer);
                drawingContainer.appendChild(colorPalette);
                drawingContainer.appendChild(drawingTools);
                drawingContainer.appendChild(templatesRow);
                drawingContainer.appendChild(actionButtons);
                
                mainContent.appendChild(drawingContainer);
                
                // Initialize the canvas
                this.initDrawingCanvas();
            },
            
            initDrawingCanvas() {
                const canvas = document.getElementById('drawing-canvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                
                // Set white background
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // If we're editing the last taken photo
                if (this.photos.length > 0 && this.currentScreen === 'drawing') {
                    const img = new Image();
                    img.onload = () => {
                        // Draw the image centered and scaled to fit
                        const scale = Math.min(canvas.width / img.width, canvas.height / img.height) * 0.9;
                        const x = (canvas.width - img.width * scale) / 2;
                        const y = (canvas.height - img.height * scale) / 2;
                        
                        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                    };
                    img.src = this.photos[0].src;
                }
                
                // Set up drawing events
                canvas.addEventListener('mousedown', this.startDrawing.bind(this));
                canvas.addEventListener('mousemove', this.draw.bind(this));
                canvas.addEventListener('mouseup', this.stopDrawing.bind(this));
                canvas.addEventListener('mouseout', this.stopDrawing.bind(this));
                
                // Touch events for mobile
                canvas.addEventListener('touchstart', this.startDrawingTouch.bind(this));
                canvas.addEventListener('touchmove', this.drawTouch.bind(this));
                canvas.addEventListener('touchend', this.stopDrawing.bind(this));
            },
            
            startDrawing(e) {
                this.isDrawing = true;
                this.lastX = e.offsetX;
                this.lastY = e.offsetY;
            },
            
            startDrawingTouch(e) {
                e.preventDefault();
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    const canvas = document.getElementById('drawing-canvas');
                    const rect = canvas.getBoundingClientRect();
                    this.lastX = touch.clientX - rect.left;
                    this.lastY = touch.clientY - rect.top;
                    this.isDrawing = true;
                }
            },
            
            draw(e) {
                if (!this.isDrawing) return;
                
                const canvas = document.getElementById('drawing-canvas');
                const ctx = canvas.getContext('2d');
                
                if (this.currentTool === 'brush') {
                    ctx.strokeStyle = this.currentColor;
                    ctx.lineWidth = 5;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    
                    ctx.beginPath();
                    ctx.moveTo(this.lastX, this.lastY);
                    ctx.lineTo(e.offsetX, e.offsetY);
                    ctx.stroke();
                    
                    this.lastX = e.offsetX;
                    this.lastY = e.offsetY;
                } else if (this.currentTool === 'stamp') {
                    // Simple stamp tool
                    ctx.fillStyle = this.currentColor;
                    ctx.beginPath();
                    ctx.arc(e.offsetX, e.offsetY, 15, 0, Math.PI * 2);
                    ctx.fill();
                }
            },
            
            drawTouch(e) {
                e.preventDefault();
                if (!this.isDrawing || e.touches.length !== 1) return;
                
                const touch = e.touches[0];
                const canvas = document.getElementById('drawing-canvas');
                const rect = canvas.getBoundingClientRect();
                const offsetX = touch.clientX - rect.left;
                const offsetY = touch.clientY - rect.top;
                
                const ctx = canvas.getContext('2d');
                
                if (this.currentTool === 'brush') {
                    ctx.strokeStyle = this.currentColor;
                    ctx.lineWidth = 5;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    
                    ctx.beginPath();
                    ctx.moveTo(this.lastX, this.lastY);
                    ctx.lineTo(offsetX, offsetY);
                    ctx.stroke();
                    
                    this.lastX = offsetX;
                    this.lastY = offsetY;
                } else if (this.currentTool === 'stamp') {
                    // Simple stamp tool
                    ctx.fillStyle = this.currentColor;
                    ctx.beginPath();
                    ctx.arc(offsetX, offsetY, 15, 0, Math.PI * 2);
                    ctx.fill();
                }
            },
            
            stopDrawing() {
                this.isDrawing = false;
            },
            
            selectColor(index) {
                // Update active color
                this.colors.forEach((colorObj, i) => {
                    colorObj.active = (i === index);
                });
                this.currentColor = this.colors[index].color;
                
                // Update UI
                const colorButtons = document.querySelectorAll('.color-button');
                colorButtons.forEach((button, i) => {
                    button.classList.toggle('active', i === index);
                });
            },
            
            selectTool(index) {
                // Update active tool
                this.tools.forEach((tool, i) => {
                    tool.active = (i === index);
                });
                this.currentTool = this.tools[index].id;
                
                // Update UI
                const toolButtons = document.querySelectorAll('.tool-button');
                toolButtons.forEach((button, i) => {
                    button.classList.toggle('active', i === index);
                });
            },
            
            addTemplate(template) {
                const canvas = document.getElementById('drawing-canvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                
                // Draw a template icon at the center
                ctx.font = '60px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(template.icon, canvas.width / 2, canvas.height / 2);
            },
            
            clearCanvas() {
                const canvas = document.getElementById('drawing-canvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            },
            
            saveDrawing() {
                const canvas = document.getElementById('drawing-canvas');
                if (!canvas) return;
                
                // Get the image as data URL
                const imageDataUrl = canvas.toDataURL('image/png');
                
                // Add to drawings array
                this.drawings.unshift({
                    src: imageDataUrl,
                    thumbnail: imageDataUrl,
                    timestamp: Date.now()
                });
                
                alert('Drawing saved! You can find it in your gallery.');
            },
            
            // Puzzle Screen
            renderPuzzleScreen() {
                const mainContent = document.getElementById('main-content');
                
                const puzzleContainer = document.createElement('div');
                puzzleContainer.className = 'puzzle-container';
                
                const title = document.createElement('h2');
                title.textContent = 'Puzzle Creator';
                title.style.color = '#805AD5';
                title.style.fontSize = '20px';
                
                // Image selection section
                const selectionSection = document.createElement('div');
                selectionSection.className = 'selection-section';
                
                const imageLabel = document.createElement('p');
                imageLabel.textContent = 'Select an image for your puzzle:';
                imageLabel.style.color = '#805AD5';
                imageLabel.style.fontSize = '14px';
                
                const puzzleImages = document.createElement('div');
                puzzleImages.className = 'puzzle-images';
                
                // Combine photos and drawings for puzzle creation
                const allImages = [...this.photos, ...this.drawings];
                
                if (allImages.length === 0) {
                    // No images available - prompt to create some first
                    const emptyMessage = document.createElement('p');
                    emptyMessage.textContent = 'Take some photos or create drawings first!';
                    emptyMessage.style.textAlign = 'center';
                    emptyMessage.style.color = '#805AD5';
                    
                    puzzleContainer.appendChild(title);
                    puzzleContainer.appendChild(emptyMessage);
                    
                    const createButton = document.createElement('button');
                    createButton.className = 'action-button';
                    createButton.innerHTML = 'ðŸ“· Take Photos';
                    createButton.addEventListener('click', () => this.navigateToScreen('camera'));
                    puzzleContainer.appendChild(createButton);
                    
                    mainContent.appendChild(puzzleContainer);
                    return;
                }
                
                allImages.slice(0, 6).forEach((image, index) => {
                    const puzzleImage = document.createElement('div');
                    puzzleImage.className = `puzzle-image ${this.selectedPuzzleImage === index ? 'active' : ''}`;
                    puzzleImage.addEventListener('click', () => this.selectPuzzleImage(index));
                    
                    const img = document.createElement('img');
                    img.src = image.thumbnail || image.src;
                    img.alt = 'Puzzle image';
                    
                    puzzleImage.appendChild(img);
                    puzzleImages.appendChild(puzzleImage);
                });
                
                selectionSection.appendChild(imageLabel);
                selectionSection.appendChild(puzzleImages);
                
                // Difficulty selection
                const difficultySection = document.createElement('div');
                difficultySection.className = 'difficulty-section';
                
                const difficultyLabel = document.createElement('p');
                difficultyLabel.textContent = 'Choose puzzle difficulty:';
                difficultyLabel.style.color = '#805AD5';
                difficultyLabel.style.fontSize = '14px';
                
                const difficultyButtons = document.createElement('div');
                difficultyButtons.className = 'difficulty-buttons';
                
                const easyButton = document.createElement('button');
                easyButton.className = `difficulty-button ${this.puzzleDifficulty === 'easy' ? 'active' : ''}`;
                easyButton.textContent = 'Easy (4 pieces)';
                easyButton.addEventListener('click', () => this.setPuzzleDifficulty('easy'));
                
                const mediumButton = document.createElement('button');
                mediumButton.className = `difficulty-button ${this.puzzleDifficulty === 'medium' ? 'active' : ''}`;
                mediumButton.textContent = 'Medium (9 pieces)';
                mediumButton.addEventListener('click', () => this.setPuzzleDifficulty('medium'));
                
                difficultyButtons.appendChild(easyButton);
                difficultyButtons.appendChild(mediumButton);
                
                difficultySection.appendChild(difficultyLabel);
                difficultySection.appendChild(difficultyButtons);
                
                // Puzzle preview
                const puzzlePreview = document.createElement('div');
                puzzlePreview.className = 'puzzle-preview';
                
                if (this.selectedPuzzleImage !== null && allImages[this.selectedPuzzleImage]) {
                    const puzzleGrid = document.createElement('div');
                    puzzleGrid.className = `puzzle-grid ${this.puzzleDifficulty}`;
                    
                    const pieces = this.puzzleDifficulty === 'easy' ? 4 : 9;
                    
                    // Create actual puzzle pieces with the image
                    const selectedImage = allImages[this.selectedPuzzleImage];
                    const img = new Image();
                    img.src = selectedImage.src;
                    
                    // Create puzzle pieces
                    for (let i = 0; i < pieces; i++) {
                        const puzzlePiece = document.createElement('div');
                        puzzlePiece.className = 'puzzle-piece';
                        
                        // Add image as background of the piece
                        puzzlePiece.style.backgroundImage = `url(${selectedImage.src})`;
                        
                        // Calculate background position based on grid
                        if (this.puzzleDifficulty === 'easy') {
                            // 2x2 grid
                            const row = Math.floor(i / 2);
                            const col = i % 2;
                            puzzlePiece.style.backgroundSize = '200%';
                            puzzlePiece.style.backgroundPosition = `${col * 100}% ${row * 100}%`;
                        } else {
                            // 3x3 grid
                            const row = Math.floor(i / 3);
                            const col = i % 3;
                            puzzlePiece.style.backgroundSize = '300%';
                            puzzlePiece.style.backgroundPosition = `${col * 50}% ${row * 50}%`;
                        }
                        
                        puzzleGrid.appendChild(puzzlePiece);
                    }
                    
                    puzzlePreview.appendChild(puzzleGrid);
                } else {
                    const placeholderText = document.createElement('div');
                    placeholderText.style.width = '100%';
                    placeholderText.style.height = '100%';
                    placeholderText.style.display = 'flex';
                    placeholderText.style.alignItems = 'center';
                    placeholderText.style.justifyContent = 'center';
                    placeholderText.style.color = '#CBD5E0';
                    placeholderText.textContent = 'Select an image to create a puzzle!';
                    
                    puzzlePreview.appendChild(placeholderText);
                }
                
                // Create button
                const createButton = document.createElement('button');
                createButton.className = 'create-button';
                createButton.textContent = 'Create My Puzzle!';
                createButton.disabled = this.selectedPuzzleImage === null;
                createButton.addEventListener('click', () => this.createPuzzle());
                
                // Add all sections to container
                puzzleContainer.appendChild(title);
                puzzleContainer.appendChild(selectionSection);
                puzzleContainer.appendChild(difficultySection);
                puzzleContainer.appendChild(puzzlePreview);
                puzzleContainer.appendChild(createButton);
                
                mainContent.appendChild(puzzleContainer);
            },
            
            selectPuzzleImage(index) {
                this.selectedPuzzleImage = index;
                this.navigateToScreen('puzzle'); // Refresh the screen
            },
            
            setPuzzleDifficulty(difficulty) {
                this.puzzleDifficulty = difficulty;
                this.navigateToScreen('puzzle'); // Refresh the screen
            },
            
            createPuzzle() {
                // Get selected image
                const allImages = [...this.photos, ...this.drawings];
                if (this.selectedPuzzleImage === null || !allImages[this.selectedPuzzleImage]) {
                    alert('Please select an image first!');
                    return;
                }
                
                // Create a playable puzzle
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = '';
                
                const puzzleContainer = document.createElement('div');
                puzzleContainer.className = 'puzzle-container';
                
                const title = document.createElement('h2');
                title.textContent = 'Solve the Puzzle!';
                title.style.color = '#805AD5';
                title.style.fontSize = '20px';
                
                const puzzleGame = document.createElement('div');
                puzzleGame.className = 'puzzle-game';
                puzzleGame.style.width = '100%';
                puzzleGame.style.aspectRatio = '1';
                puzzleGame.style.position = 'relative';
                puzzleGame.style.backgroundColor = '#F7FAFC';
                puzzleGame.style.borderRadius = '12px';
                puzzleGame.style.overflow = 'hidden';
                
                // Create draggable puzzle pieces
                const selectedImage = allImages[this.selectedPuzzleImage];
                const pieces = this.puzzleDifficulty === 'easy' ? 4 : 9;
                const grid = this.puzzleDifficulty === 'easy' ? 2 : 3;
                
                // Randomize piece order
                const pieceOrder = Array.from({length: pieces}, (_, i) => i);
                for (let i = pieceOrder.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [pieceOrder[i], pieceOrder[j]] = [pieceOrder[j], pieceOrder[i]];
                }
                
                // Calculate piece size based on container
                const pieceSize = 100 / grid; // percentage
                
                // Create the pieces
                for (let i = 0; i < pieces; i++) {
                    const originalPos = pieceOrder[i];
                    const row = Math.floor(originalPos / grid);
                    const col = originalPos % grid;
                    
                    const piece = document.createElement('div');
                    piece.className = 'puzzle-piece draggable';
                    piece.setAttribute('data-original-pos', originalPos);
                    piece.setAttribute('data-current-pos', i);
                    
                    // Set positioning styles for the piece
                    piece.style.width = `${pieceSize}%`;
                    piece.style.height = `${pieceSize}%`;
                    piece.style.position = 'absolute';
                    piece.style.backgroundImage = `url(${selectedImage.src})`;
                    piece.style.backgroundSize = `${grid * 100}%`;
                    piece.style.backgroundPosition = `${col * 100 / (grid-1)}% ${row * 100 / (grid-1)}%`;
                    piece.style.border = '1px solid white';
                    piece.style.boxSizing = 'border-box';
                    
                    // Position in the grid
                    const currentRow = Math.floor(i / grid);
                    const currentCol = i % grid;
                    piece.style.top = `${currentRow * pieceSize}%`;
                    piece.style.left = `${currentCol * pieceSize}%`;
                    
                    // Make draggable
                    piece.style.touchAction = 'none';
                    piece.style.cursor = 'grab';
                    piece.style.transition = 'transform 0.1s';
                    
                    // Setup drag events
                    this.setupPuzzleDrag(piece);
                    
                    puzzleGame.appendChild(piece);
                }
                
                const backButton = document.createElement('button');
                backButton.className = 'action-button';
                backButton.style.marginTop = '20px';
                backButton.innerHTML = 'â¬…ï¸ Back to Puzzle Maker';
                backButton.addEventListener('click', () => this.navigateToScreen('puzzle'));
                
                puzzleContainer.appendChild(title);
                puzzleContainer.appendChild(puzzleGame);
                puzzleContainer.appendChild(backButton);
                
                mainContent.appendChild(puzzleContainer);
            },
            
            setupPuzzleDrag(piece) {
                let startX, startY, initialLeft, initialTop;
                let targetPiece = null;
                
                const onStart = (clientX, clientY) => {
                    // Start dragging
                    startX = clientX;
                    startY = clientY;
                    
                    // Store initial position
                    const style = window.getComputedStyle(piece);
                    initialLeft = parseInt(style.left);
                    initialTop = parseInt(style.top);
                    
                    // Visual feedback
                    piece.style.zIndex = '10';
                    piece.style.cursor = 'grabbing';
                    piece.style.transform = 'scale(1.05)';
                    piece.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
                };
                
                const onMove = (clientX, clientY) => {
                    if (startX === undefined) return;
                    
                    // Calculate movement
                    const deltaX = clientX - startX;
                    const deltaY = clientY - startY;
                    
                    // Move the piece
                    piece.style.left = `${initialLeft + deltaX}px`;
                    piece.style.top = `${initialTop + deltaY}px`;
                    
                    // Check for overlapping pieces (simple center point check)
                    const pieceRect = piece.getBoundingClientRect();
                    const pieceCenter = {
                        x: pieceRect.left + pieceRect.width / 2,
                        y: pieceRect.top + pieceRect.height / 2
                    };
                    
                    // Find target piece (if any)
                    targetPiece = null;
                    document.querySelectorAll('.puzzle-piece').forEach(otherPiece => {
                        if (otherPiece === piece) return;
                        
                        const otherRect = otherPiece.getBoundingClientRect();
                        if (
                            pieceCenter.x >= otherRect.left && 
                            pieceCenter.x <= otherRect.right && 
                            pieceCenter.y >= otherRect.top && 
                            pieceCenter.y <= otherRect.bottom
                        ) {
                            targetPiece = otherPiece;
                            targetPiece.style.transform = 'scale(0.95)';
                            targetPiece.style.opacity = '0.8';
                        } else if (otherPiece.style.transform === 'scale(0.95)') {
                            otherPiece.style.transform = '';
                            otherPiece.style.opacity = '';
                        }
                    });
                };
                
                const onEnd = () => {
                    if (startX === undefined) return;
                    
                    // Reset visual feedback
                    piece.style.zIndex = '';
                    piece.style.cursor = 'grab';
                    piece.style.transform = '';
                    piece.style.boxShadow = '';
                    
                    if (targetPiece) {
                        // Swap positions with target piece
                        const targetLeft = window.getComputedStyle(targetPiece).left;
                        const targetTop = window.getComputedStyle(targetPiece).top;
                        
                        // Swap current positions
                        targetPiece.style.left = `${initialLeft}px`;
                        targetPiece.style.top = `${initialTop}px`;
                        piece.style.left = targetLeft;
                        piece.style.top = targetTop;
                        
                        // Swap data attributes
                        const tempPos = piece.getAttribute('data-current-pos');
                        piece.setAttribute('data-current-pos', targetPiece.getAttribute('data-current-pos'));
                        targetPiece.setAttribute('data-current-pos', tempPos);
                        
                        // Reset target piece styling
                        targetPiece.style.transform = '';
                        targetPiece.style.opacity = '';
                        
                        // Check if puzzle is solved
                        this.checkPuzzleSolved();
                    } else {
                        // Return to original position if no target piece
                        piece.style.left = `${initialLeft}px`;
                        piece.style.top = `${initialTop}px`;
                    }
                    
                    // Reset the drag state
                    startX = startY = undefined;
                };
                
                // Mouse events
                piece.addEventListener('mousedown', e => {
                    onStart(e.clientX, e.clientY);
                });
                
                document.addEventListener('mousemove', e => {
                    onMove(e.clientX, e.clientY);
                });
                
                document.addEventListener('mouseup', () => {
                    onEnd();
                });
                
                // Touch events
                piece.addEventListener('touchstart', e => {
                    if (e.touches.length !== 1) return;
                    e.preventDefault(); // Prevent scrolling
                    const touch = e.touches[0];
                    onStart(touch.clientX, touch.clientY);
                });
                
                piece.addEventListener('touchmove', e => {
                    if (e.touches.length !== 1) return;
                    e.preventDefault(); // Prevent scrolling
                    const touch = e.touches[0];
                    onMove(touch.clientX, touch.clientY);
                });
                
                piece.addEventListener('touchend', () => {
                    onEnd();
                });
            },
            
            checkPuzzleSolved() {
                const pieces = document.querySelectorAll('.puzzle-piece');
                let solved = true;
                
                pieces.forEach(piece => {
                    const originalPos = parseInt(piece.getAttribute('data-original-pos'));
                    const currentPos = parseInt(piece.getAttribute('data-current-pos'));
                    
                    if (originalPos !== currentPos) {
                        solved = false;
                    }
                });
                
                if (solved) {
                    // Celebration animation
                    pieces.forEach(piece => {
                        piece.style.border = 'none';
                        piece.style.transition = 'transform 0.5s';
                        piece.style.transform = 'scale(1.02)';
                    });
                    
                    // Show victory message
                    setTimeout(() => {
                        alert('ðŸŽ‰ Great job! You solved the puzzle! ðŸŽ‰');
                        this.navigateToScreen('puzzle');
                    }, 500);
                }
            },
            
            // Gallery Screen
            renderGalleryScreen() {
                const mainContent = document.getElementById('main-content');
                
                const galleryContainer = document.createElement('div');
                galleryContainer.className = 'gallery-container';
                
                const title = document.createElement('h2');
                title.textContent = 'My Gallery';
                title.style.color = '#805AD5';
                title.style.fontSize = '20px';
                
                // Grid of images
                const galleryGrid = document.createElement('div');
                galleryGrid.className = 'gallery-grid';
                
                // Combine photos and drawings for display
                const allItems = [...this.photos, ...this.drawings];
                
                if (allItems.length === 0) {
                    const emptyMessage = document.createElement('p');
                    emptyMessage.textContent = 'Your gallery is empty. Take some photos or create drawings!';
                    emptyMessage.style.textAlign = 'center';
                    emptyMessage.style.color = '#805AD5';
                    galleryContainer.appendChild(emptyMessage);
                } else {
                    allItems.forEach((item, index) => {
                        const galleryItem = document.createElement('div');
                        galleryItem.className = 'gallery-item';
                        
                        const img = document.createElement('img');
                        img.className = 'gallery-image';
                        img.src = item.thumbnail || item.src;
                        img.alt = 'Gallery item';
                        
                        const overlay = document.createElement('div');
                        overlay.className = 'gallery-overlay';
                        
                        galleryItem.appendChild(img);
                        galleryItem.appendChild(overlay);
                        galleryItem.addEventListener('click', () => this.viewGalleryItem(index));
                        
                        galleryGrid.appendChild(galleryItem);
                    });
                }
                
                // Action buttons
                const actionButtons = document.createElement('div');
                actionButtons.className = 'action-buttons';
                
                const saveButton = document.createElement('button');
                saveButton.className = 'action-button';
                saveButton.innerHTML = 'ðŸ’¾ Save';
                saveButton.addEventListener('click', () => this.saveAllToDevice());
                
                const printButton = document.createElement('button');
                printButton.className = 'action-button';
                printButton.innerHTML = 'ðŸ–¨ï¸ Print';
                printButton.addEventListener('click', () => this.printGallery());
                
                const shareButton = document.createElement('button');
                shareButton.className = 'action-button';
                shareButton.innerHTML = 'ðŸ“¤ Share';
                shareButton.addEventListener('click', () => this.shareGallery());
                
                actionButtons.appendChild(saveButton);
                actionButtons.appendChild(printButton);
                actionButtons.appendChild(shareButton);
                
                // Add all sections to container
                galleryContainer.appendChild(title);
                galleryContainer.appendChild(galleryGrid);
                galleryContainer.appendChild(actionButtons);
                
                mainContent.appendChild(galleryContainer);
            },
            
            viewGalleryItem(index) {
                // In a real app, this would open a fullscreen view
                const allItems = [...this.photos, ...this.drawings];
                
                if (allItems[index]) {
                    // Create a modal to view the image
                    const modal = document.createElement('div');
                    modal.style.position = 'fixed';
                    modal.style.top = '0';
                    modal.style.left = '0';
                    modal.style.width = '100%';
                    modal.style.height = '100%';
                    modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
                    modal.style.display = 'flex';
                    modal.style.alignItems = 'center';
                    modal.style.justifyContent = 'center';
                    modal.style.zIndex = '9999';
                    
                    const img = document.createElement('img');
                    img.src = allItems[index].src;
                    img.style.maxWidth = '90%';
                    img.style.maxHeight = '90%';
                    img.style.objectFit = 'contain';
                    
                    modal.appendChild(img);
                    document.body.appendChild(modal);
                    
                    // Close modal when clicked
                    modal.addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });
                }
            },
            
            saveAllToDevice() {
                alert('On a real device, this would save all images to your photo library!');
                // In a real app, this would use the device's file system API
            },
            
            printGallery() {
                alert('On a real device, this would open the print dialog!');
                // In a real app, this would use the device's print API
            },
            
            shareGallery() {
                alert('On a real device, this would open sharing options!');
                // In a real app, this would use the Web Share API
            }
        };
        
        // Start the app when the page loads
        window.addEventListener('load', () => {
            app.init();
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Animal Art Adventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #EBF4FF;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: manipulation;
            padding: 0;
            margin: 0;
        }

        /* Fixed positioning for bottom nav */
        footer {
            background-color: #9F7AEA;
            padding: 10px 0;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0px -2px 10px rgba(0,0,0,0.1);
            /* Add extra bottom padding for notched iPhones */
            padding-bottom: env(safe-area-inset-bottom, 10px);
        }

        /* Main content needs bottom padding to not be hidden behind fixed footer */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            /* Add padding equal to footer height + extra space */
            padding-bottom: 80px;
            -webkit-overflow-scrolling: touch;
            margin-bottom: env(safe-area-inset-bottom, 0px);
            height: calc(100vh - 100px);
        }

        /* Make app container height allow for fixed footer */
        .app-container {
            max-width: 800px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            padding-bottom: env(safe-area-inset-bottom, 0px);
        }
        
        header {
            background-color: #9F7AEA; /* purple header */
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        nav {
            display: flex;
            justify-content: space-around;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        
        /* Make buttons extra large for iPad */
        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: white;
            padding: 10px 5px;
            border-radius: 8px;
            min-width: 60px;
            min-height: 60px;
        }
        
        .nav-button.active {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        /* Make icons bigger */
        .nav-icon {
            font-size: 30px;
            margin-bottom: 4px;
        }
        
        .nav-label {
            font-size: 12px;
        }
        
        /* Home Screen Styles */
        .home-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 20px;
        }
        
        .home-title {
            color: #805AD5;
            font-size: 24px;
            text-align: center;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            max-width: 400px;
        }
        
        .feature-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .feature-card:active {
            transform: scale(0.95);
        }
        
        .feature-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .feature-title {
            font-size: 16px;
            font-weight: bold;
            color: #553C9A;
        }
        
        /* Camera Screen Styles */
        .camera-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            gap: 15px;
        }
        
        .viewfinder {
            width: 100%;
            aspect-ratio: 1;
            background-color: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        #camera-view {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .viewfinder-frame {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 4px dashed #FFD700;
            border-radius: 8px;
            pointer-events: none;
        }
        
        .camera-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            width: 100%;
        }
        
        .camera-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .camera-button.capture {
            width: 70px;
            height: 70px;
            background-color: #E53E3E;
        }
        
        .camera-button.small {
            width: 50px;
            height: 50px;
        }
        
        /* Drawing Screen Styles */
        .drawing-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            gap: 10px;
        }
        
        #drawing-canvas {
            width: 100%;
            aspect-ratio: 1;
            background-color: white;
            border-radius: 12px;
            border: 2px solid #CBD5E0;
            touch-action: none; /* Prevents scrolling while drawing */
        }
        
        .color-palette {
            display: flex;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }
        
        .color-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
        }
        
        .color-button.active {
            border: 3px solid #805AD5;
        }
        
        .drawing-tools {
            display: flex;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 10px;
            background-color: #EDE9FE;
            border-radius: 12px;
        }
        
        .tool-button {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border: none;
            border-radius: 8px;
            font-size: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .tool-button.active {
            background-color: #805AD5;
            color: white;
        }
        
        .templates-row {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            width: 100%;
            padding: 5px 0;
        }
        
        .template-item {
            flex-shrink: 0;
            width: 70px;
            height: 70px;
            background-color: white;
            border-radius: 8px;
            border: 2px solid #CBD5E0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .template-icon {
            font-size: 28px;
        }
        
        .template-label {
            font-size: 10px;
        }
        
        /* Gallery Screen Styles */
        .gallery-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            gap: 15px;
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
        }
        
        .gallery-item {
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .gallery-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .gallery-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }
        
        .gallery-item:active .gallery-overlay {
            background-color: rgba(0,0,0,0.3);
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            width: 100%;
        }
        
        .action-button {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 20px;
            background-color: #EDE9FE;
            color: #805AD5;
            border: none;
            border-radius:.5rem;
            font-weight: 600;
        }
        
        /* Puzzle Screen Styles */
        .puzzle-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            gap: 10px;
        }
        
        .puzzle-images {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            width: 100%;
            padding: 5px 0;
        }
        
        .puzzle-image {
            flex-shrink: 0;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .puzzle-image.active {
            border: 3px solid #805AD5;
        }
        
        .puzzle-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .difficulty-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            width: 100%;
        }
        
        .difficulty-button {
            padding: 10px 15px;
            background-color: #E2E8F0;
            border: none;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .difficulty-button.active {
            background-color: #68D391;
            color: white;
        }
        
        .puzzle-preview {
            width: 100%;
            aspect-ratio: 1;
            background-color: white;
            border-radius: 12px;
            border: 2px solid #CBD5E0;
            padding: 10px;
            position: relative;
        }
        
        .puzzle-grid {
            width: 100%;
            height: 100%;
            display: grid;
            gap: 3px;
        }
        
        .puzzle-grid.easy {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
        }
        
        .puzzle-grid.medium {
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
        }
        
        .puzzle-piece {
            background-color: #E2E8F0;
            border-radius: 4px;
        }
        
        .create-button {
            padding: 12px 25px;
            background-color: #805AD5;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(129, 62, 226, 0.4);
        }
        
        .create-button:disabled {
            opacity: 0.5;
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        /* Loading spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 4px solid #805AD5;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>Animal Art Adventure</h1>
        </header>
        
        <main id="main-content">
            <!-- Screen content will be dynamically inserted here -->
        </main>
        
        <footer>
            <nav>
                <button class="nav-button" data-screen="home">
                    <div class="nav-icon">ðŸ </div>
                    <div class="nav-label">Home</div>
                </button>
                <button class="nav-button" data-screen="camera">
                    <div class="nav-icon">ðŸ“·</div>
                    <div class="nav-label">Camera</div>
                </button>
                <button class="nav-button" data-screen="drawing">
                    <div class="nav-icon">ðŸŽ¨</div>
                    <div class="nav-label">Draw</div>
                </button>
                <button class="nav-button" data-screen="puzzle">
                    <div class="nav-icon">ðŸ§©</div>
                    <div class="nav-label">Puzzle</div>
                </button>
                <button class="nav-button" data-screen="gallery">
                    <div class="nav-icon">ðŸ“±</div>
                    <div class="nav-label">Gallery</div>
                </button>
            </nav>
        </footer>
    </div>

    <script>
        // Main app state
        const app = {
            currentScreen: 'home',
            photos: [],
            drawings: [],
            cameraStream: null,
            currentCameraFacing: 'environment',
            currentColor: '#FF4081',
            currentTool: 'brush',
            isDrawing: false,
            lastX: 0,
            lastY: 0,
            selectedPuzzleImage: null,
            puzzleDifficulty: 'easy',
            templates: [
                { icon: 'ðŸ¾', label: 'paws' },
                { icon: 'ðŸ­', label: 'ears' },
                { icon: 'ðŸ¦Š', label: 'tails' },
                { icon: 'ðŸ¦…', label: 'wings' },
                { icon: 'ðŸ¦†', label: 'beaks' }
            ],
            colors: [
                { color: '#FF4081', active: true },
                { color: '#3F51B5', active: false },
                { color: '#4CAF50', active: false },
                { color: '#FFC107', active: false },
                { color: '#FF5722', active: false },
                { color: '#9C27B0', active: false }
            ],
            tools: [
                { id: 'brush', icon: 'âœï¸', active: true },
                { id: 'stamp', icon: 'ðŸ¾', active: false },
                { id: 'sticker', icon: 'ðŸ¦Š', active: false },
                { id: 'fill', icon: 'ðŸŽ¨', active: false }
            ],
            
            // Add sample images for testing
            init() {
                // Add sample images
                this.addSampleImages();
                
                // Setup navigation
                document.querySelectorAll('.nav-button').forEach(button => {
                    button.addEventListener('click', () => {
                        this.navigateToScreen(button.dataset.screen);
                    });
                });
                
                // Set up the first screen
                this.navigateToScreen('home');
                
                // Setup service worker for PWA capabilities
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('service-worker.js').then(registration => {
                            console.log('ServiceWorker registration successful');
                        }).catch(error => {
                            console.log('ServiceWorker registration failed: ', error);
                        });
                    });
                }
            },
            
            addSampleImages() {
                // Add sample photos
                this.photos.push(
                    { src: 'https://images.unsplash.com/photo-1546182990-dffeafbe841d', thumbnail: 'https://images.unsplash.com/photo-1546182990-dffeafbe841d?w=200' },
                    { src: 'https://images.unsplash.com/photo-1591824438708-ce405f36ba3d', thumbnail: 'https://images.unsplash.com/photo-1591824438708-ce405f36ba3d?w=200' }
                );
                
                // Add sample drawings
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 400;
                const ctx = canvas.getContext('2d');
                
                // Create a sample drawing
                ctx.fillStyle = '#FFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = '#FF4081';
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.arc(200, 200, 100, 0, Math.PI * 2);
                ctx.stroke();
                
                this.drawings.push({ src: canvas.toDataURL(), thumbnail: canvas.toDataURL() });
                
                // Create another sample drawing
                ctx.fillStyle = '#FFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#4CAF50';
                ctx.fillRect(100, 100, 200, 200);
                
                this.drawings.push({ src: canvas.toDataURL(), thumbnail: canvas.toDataURL() });
            },
            
            navigateToScreen(screenName) {
                // Stop camera if leaving camera screen
                if (this.currentScreen === 'camera' && screenName !== 'camera') {
                    this.stopCamera();
                }
                
                // Update current screen
                this.currentScreen = screenName;
                
                // Update active nav button
                document.querySelectorAll('.nav-button').forEach(button => {
                    button.classList.toggle('active', button.dataset.screen === screenName);
                });
                
                // Clear main content
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = '';
                
                // Render the new screen
                switch (screenName) {
                    case 'home':
                        this.renderHomeScreen();
                        break;
                    case 'camera':
                        this.renderCameraScreen();
                        break;
                    case 'drawing':
                        this.renderDrawingScreen();
                        break;
                    case 'puzzle':
                        this.renderPuzzleScreen();
                        break;
                    case 'gallery':
                        this.renderGalleryScreen();
                        break;
                }
            },
            
            // Home Screen
            renderHomeScreen() {
                const mainContent = document.getElementById('main-content');
                
                const homeContainer = document.createElement('div');
                homeContainer.className = 'home-container';
                
                const homeTitle = document.createElement('h2');
                homeTitle.className = 'home-title';
                homeTitle.textContent = 'Welcome to Animal Art Adventure!';
                
                const featureGrid = document.createElement('div');
                featureGrid.className = 'feature-grid';
                
                // Define the features
                const features = [
                    { icon: 'ðŸ“·', title: 'Take Photos', color: '#FED7E2', screen: 'camera' },
                    { icon: 'ðŸŽ¨', title: 'Draw Animals', color: '#C3DAFE', screen: 'drawing' },
                    { icon: 'ðŸ§©', title: 'Make Puzzles', color: '#C6F6D5', screen: 'puzzle' },
                    { icon: 'ðŸ“±', title: 'My Gallery', color: '#FEEBC8', screen: 'gallery' }
                ];
                
                // Create the feature cards
                features.forEach(feature => {
                    const card = document.createElement('div');
                    card.className = 'feature-card';
                    card.style.backgroundColor = feature.color;
                    card.addEventListener('click', () => this.navigateToScreen(feature.screen));
                    
                    const icon = document.createElement('div');
                    icon.className = 'feature-icon';
                    icon.textContent = feature.icon;
                    
                    const title = document.createElement('div');
                    title.className = 'feature-title';
                    title.textContent = feature.title;
                    
                    card.appendChild(icon);
                    card.appendChild(title);
                    featureGrid.appendChild(card);
                });
                
                homeContainer.appendChild(homeTitle);
                homeContainer.appendChild(featureGrid);
                mainContent.appendChild(homeContainer);
            },
            
            // Camera Screen
            renderCameraScreen() {
                const mainContent = document.getElementById('main-content');
                
                const cameraContainer = document.createElement('div');
                cameraContainer.className = 'camera-container';
                
                const title = document.createElement('h2');
                title.textContent = 'Capture Animals!';
                title.style.color = '#805AD5';
                title.style.fontSize = '20px';
                
                const viewfinder = document.createElement('div');
                viewfinder.className = 'viewfinder';
                
                const cameraView = document.createElement('video');
                cameraView.id = 'camera-view';
                cameraView.autoplay = true;
                cameraView.playsInline = true; // Important for iOS
                
                const viewfinderFrame = document.createElement('div');
                viewfinderFrame.className = 'viewfinder-frame';
                
                viewfinder.appendChild(cameraView);
                viewfinder.appendChild(viewfinderFrame);
                
                const cameraControls = document.createElement('div');
                cameraControls.className = 'camera-controls';
                
                const galleryButton = document.createElement('button');
                galleryButton.className = 'camera-button small';
                galleryButton.innerHTML = 'ðŸ–¼ï¸';
                galleryButton.addEventListener('click', () => this.navigateToScreen('gallery'));
                
                const captureButton = document.createElement('button');
                captureButton.className = 'camera-button capture';
                captureButton.innerHTML = 'ðŸ“·';
                captureButton.addEventListener('click', () => this.capturePhoto());
                
                const switchButton = document.createElement('button');
                switchButton.className = 'camera-button small';
                switchButton.innerHTML = this.currentCameraFacing === 'environment' ? 'ðŸ“·â†”ï¸' : 'ðŸ¤³';
                switchButton.addEventListener('click', () => this.toggleCamera());
                
                cameraControls.appendChild(galleryButton);
                cameraControls.appendChild(captureButton);
                cameraControls.appendChild(switchButton);
                
                const helpText = document.createElement('p');
                helpText.textContent = 'Starting camera...';
                helpText.style.textAlign = 'center';
                helpText.style.color = '#805AD5';
                helpText.style.fontSize = '14px';
                
                cameraContainer.appendChild(title);
                cameraContainer.appendChild(viewfinder);
                cameraContainer.appendChild(cameraControls);
                cameraContainer.appendChild(helpText);
                
                mainContent.appendChild(cameraContainer);
                
                // Start the camera
                this.startCamera();
            },
            
            startCamera() {
                // First check if we have permission
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    // Default to environment camera first
                    const constraints = { 
                        video: { 
                            facingMode: this.currentCameraFacing,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    };
                    
                    // Try to get camera access
                    navigator.mediaDevices.getUserMedia(constraints)
                    .then(stream => {
                        const video = document.getElementById('camera-view');
                        if (video) {
                            this.cameraStream = stream;
                            video.srcObject = stream;
                            
                            // Add message indicating camera is working
                            const helpText = document.querySelector('.camera-container p');
                            if (helpText) {
                                helpText.textContent = 'Camera ready! Find an animal and take its picture!';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Camera error:', error);
                        
                        // Show a helpful error message based on the error
                        let errorMessage = 'Could not access the camera. ';
                        
                        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                            errorMessage += 'Please allow camera access in your browser settings.';
                        } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                            errorMessage += 'No camera was found on your device.';
                        } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                            errorMessage += 'Your camera might be in use by another application.';
                        } else {
                            errorMessage += 'Try using the "Add to Home Screen" option for better camera access.';
                        }
                        
                        alert(errorMessage);
                        
                        // Update the UI to show error
                        const helpText = document.querySelector('.camera-container p');
                        if (helpText) {
                            helpText.textContent = 'Camera not available. Try using "Add to Home Screen" option.';
                            helpText.style.color = '#E53E3E';
                        }
                    });
                } else {
                    alert('Sorry, your browser does not support camera access. Try using Safari and adding this app to your home screen.');
                }
            },
            
            stopCamera() {
                // Stop the camera stream properly
                if (this.cameraStream) {
                    this.cameraStream.getTracks().forEach(track => {
                        track.stop();
                    });
                    this.cameraStream = null;
                }
            },
            
            toggleCamera() {
                // Toggle between front and rear cameras
                this.stopCamera();
                
                // Toggle camera direction
                this.currentCameraFacing = this.currentCameraFacing === 'environment' ? 'user' : 'environment';
                
                // Update switch camera button to show which camera is active
                const switchButton = document.querySelector('.camera-button.small:last-child');
                if (switchButton) {
                    switchButton.innerHTML = this.currentCameraFacing === 'environment' ? 'ðŸ“·â†”ï¸' : 'ðŸ¤³';
                }
                
                // Request camera with new facing mode
                const constraints = { 
                    video: { 
                        facingMode: this.currentCameraFacing,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };
                
                navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    const video = document.getElementById('camera-view');
                    if (video) {
                        this.cameraStream = stream;
                        video.srcObject = stream;
                    }
                })
                .catch(error => {
                    console.error('Camera switch error:', error);
                    alert('Could not switch camera. Your device might not support multiple cameras.');
                    
                    // Try to revert to the previously working camera
                    this.currentCameraFacing = this.currentCameraFacing === 'environment' ? 'user' : 'environment';
                    this.startCamera();
                });
            },
            
            capturePhoto() {
                const video = document.getElementById('camera-view');
                if (!video || !this.cameraStream) return;
                
                // Create a canvas to capture the photo
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Get the image as data URL
                const imageDataUrl = canvas.toDataURL('image/jpeg');
                
                // Add to photos array
                this.photos.unshift({
                    src: imageDataUrl,
                    thumbnail: imageDataUrl,
                    timestamp: Date.now()
                });
                
                // Show capture animation
                const viewfinder = document.querySelector('.viewfinder');
                if (viewfinder) {
                    viewfinder
