<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Animal Art Adventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #EBF4FF; /* light blue background */
            overscroll-behavior: none; /* prevents pull-to-refresh on iOS */
        }
        
        /* For Safari on iOS to prevent elastic scrolling while ensuring the bottom nav is visible */
        html, body {
            position: fixed;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        
        /* Ensure bottom nav is visible on iPad Safari */
        footer {
            background-color: #9F7AEA;
            padding: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            position: relative;
            z-index: 100;
        }
        
        /* Add bottom padding to main content to prevent it from being hidden behind nav */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            position: relative;
            padding-bottom: 20px;
            margin-bottom: 0;
        }
        
        /* Ensure app container accounts for iOS safe areas */
        .app-container {
            max-width: 800px;
            margin: 0 auto;
            height: 100vh;
            height: calc(100vh - env(safe-area-inset-bottom));
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        header {
            background-color: #9F7AEA; /* purple header */
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        nav {
            display: flex;
            justify-content: space-around;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        
        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            color: white;
            padding: 5px;
            border-radius: 8px;
            min-width: 50px;
            min-height: 50px;
        }
        
        .nav-button.active {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        .nav-label {
            font-size: 12px;
        }
        
        /* Home Screen Styles */
        .home-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 20px;
        }
        
        .home-title {
            color: #805AD5;
            font-size: 24px;
            text-align: center;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            max-width: 400px;
        }
        
        .feature-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .feature-card:active {
            transform: scale(0.95);
        }
        
        .feature-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .feature-title {
            font-size: 16px;
            font-weight: bold;
            color: #553C9A;
        }
        
        /* Camera Screen Styles */
        .camera-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            gap: 15px;
        }
        
        .viewfinder {
            width: 100%;
            aspect-ratio: 1;
            background-color: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        #camera-view {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .viewfinder-frame {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 4px dashed #FFD700;
            border-radius: 8px;
            pointer-events: none;
        }
        
        .camera-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            width: 100%;
        }
        
        .camera-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .camera-button.capture {
            width: 70px;
            height: 70px;
            background-color: #E53E3E;
        }
        
        .camera-button.small {
            width: 50px;
            height: 50px;
        }
        
        /* Drawing Screen Styles */
        .drawing-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            gap: 10px;
        }
        
        #drawing-canvas {
            width: 100%;
            aspect-ratio: 1;
            background-color: white;
            border-radius: 12px;
            border: 2px solid #CBD5E0;
            touch-action: none; /* Prevents scrolling while drawing */
        }
        
        .color-palette {
            display: flex;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }
        
        .color-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
        }
        
        .color-button.active {
            border: 3px solid #805AD5;
        }
        
        .drawing-tools {
            display: flex;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 10px;
            background-color: #EDE9FE;
            border-radius: 12px;
        }
        
        .tool-button {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border: none;
            border-radius: 8px;
            font-size: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .tool-button.active {
            background-color: #805AD5;
            color: white;
        }
        
        .templates-row {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            width: 100%;
            padding: 5px 0;
        }
        
        .template-item {
            flex-shrink: 0;
            width: 70px;
            height: 70px;
            background-color: white;
            border-radius: 8px;
            border: 2px solid #CBD5E0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .template-icon {
            font-size: 28px;
        }
        
        .template-label {
            font-size: 10px;
        }
        
        /* Gallery Screen Styles */
        .gallery-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            gap: 15px;
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
        }
        
        .gallery-item {
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .gallery-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .gallery-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }
        
        .gallery-item:active .gallery-overlay {
            background-color: rgba(0,0,0,0.3);
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            width: 100%;
        }
        
        .action-button {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 20px;
            background-color: #EDE9FE;
            color: #805AD5;
            border: none;
            border-radius:.5rem;
            font-weight: 600;
        }
        
        /* Puzzle Screen Styles */
        .puzzle-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            gap: 10px;
        }
        
        .puzzle-images {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            width: 100%;
            padding: 5px 0;
        }
        
        .puzzle-image {
            flex-shrink: 0;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .puzzle-image.active {
            border: 3px solid #805AD5;
        }
        
        .puzzle-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .difficulty-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            width: 100%;
        }
        
        .difficulty-button {
            padding: 10px 15px;
            background-color: #E2E8F0;
            border: none;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .difficulty-button.active {
            background-color: #68D391;
            color: white;
        }
        
        .puzzle-preview {
            width: 100%;
            aspect-ratio: 1;
            background-color: white;
            border-radius: 12px;
            border: 2px solid #CBD5E0;
            padding: 10px;
            position: relative;
        }
        
        .puzzle-grid {
            width: 100%;
            height: 100%;
            display: grid;
            gap: 3px;
        }
        
        .puzzle-grid.easy {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
        }
        
        .puzzle-grid.medium {
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
        }
        
        .puzzle-piece {
            background-color: #E2E8F0;
            border-radius: 4px;
        }
        
        .create-button {
            padding: 12px 25px;
            background-color: #805AD5;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(129, 62, 226, 0.4);
        }
        
        .create-button:disabled {
            opacity: 0.5;
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        /* Loading spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 4px solid #805AD5;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>Animal Art Adventure</h1>
        </header>
        
        <main id="main-content">
            <!-- Screen content will be dynamically inserted here -->
        </main>
        
        <footer>
            <nav>
                <button class="nav-button" data-screen="home">
                    <div class="nav-icon">🏠</div>
                    <div class="nav-label">Home</div>
                </button>
                <button class="nav-button" data-screen="camera">
                    <div class="nav-icon">📷</div>
                    <div class="nav-label">Camera</div>
                </button>
                <button class="nav-button" data-screen="drawing">
                    <div class="nav-icon">🎨</div>
                    <div class="nav-label">Draw</div>
                </button>
                <button class="nav-button" data-screen="puzzle">
                    <div class="nav-icon">🧩</div>
                    <div class="nav-label">Puzzle</div>
                </button>
                <button class="nav-button" data-screen="gallery">
                    <div class="nav-icon">📱</div>
                    <div class="nav-label">Gallery</div>
                </button>
            </nav>
        </footer>
    </div>

    <script>
        // Main app state
        const app = {
            currentScreen: 'home',
            photos: [],
            drawings: [],
            cameraStream: null,
            currentColor: '#FF4081',
            currentTool: 'brush',
            isDrawing: false,
            lastX: 0,
            lastY: 0,
            selectedPuzzleImage: null,
            puzzleDifficulty: 'easy',
            templates: [
                { icon: '🐾', label: 'paws' },
                { icon: '🐭', label: 'ears' },
                { icon: '🦊', label: 'tails' },
                { icon: '🦅', label: 'wings' },
                { icon: '🦆', label: 'beaks' }
            ],
            colors: [
                { color: '#FF4081', active: true },
                { color: '#3F51B5', active: false },
                { color: '#4CAF50', active: false },
                { color: '#FFC107', active: false },
                { color: '#FF5722', active: false },
                { color: '#9C27B0', active: false }
            ],
            tools: [
                { id: 'brush', icon: '✏️', active: true },
                { id: 'stamp', icon: '🐾', active: false },
                { id: 'sticker', icon: '🦊', active: false },
                { id: 'fill', icon: '🎨', active: false }
            ],
            
            // Add sample images for testing
            init() {
                // Add sample images
                this.addSampleImages();
                
                // Setup navigation
                document.querySelectorAll('.nav-button').forEach(button => {
                    button.addEventListener('click', () => {
                        this.navigateToScreen(button.dataset.screen);
                    });
                });
                
                // Set up the first screen
                this.navigateToScreen('home');
                
                // Setup service worker for PWA capabilities
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('/service-worker.js').then(registration => {
                            console.log('ServiceWorker registration successful');
                        }).catch(error => {
                            console.log('ServiceWorker registration failed: ', error);
                        });
                    });
                }
            },
            
            addSampleImages() {
                // Add sample photos
                this.photos.push(
                    { src: 'https://images.unsplash.com/photo-1546182990-dffeafbe841d', thumbnail: 'https://images.unsplash.com/photo-1546182990-dffeafbe841d?w=200' },
                    { src: 'https://images.unsplash.com/photo-1591824438708-ce405f36ba3d', thumbnail: 'https://images.unsplash.com/photo-1591824438708-ce405f36ba3d?w=200' }
                );
                
                // Add sample drawings
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 400;
                const ctx = canvas.getContext('2d');
                
                // Create a sample drawing
                ctx.fillStyle = '#FFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = '#FF4081';
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.arc(200, 200, 100, 0, Math.PI * 2);
                ctx.stroke();
                
                this.drawings.push({ src: canvas.toDataURL(), thumbnail: canvas.toDataURL() });
                
                // Create another sample drawing
                ctx.fillStyle = '#FFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#4CAF50';
                ctx.fillRect(100, 100, 200, 200);
                
                this.drawings.push({ src: canvas.toDataURL(), thumbnail: canvas.toDataURL() });
            },
            
            navigateToScreen(screenName) {
                // Stop camera if leaving camera screen
                if (this.currentScreen === 'camera' && screenName !== 'camera') {
                    this.stopCamera();
                }
                
                // Update current screen
                this.currentScreen = screenName;
                
                // Update active nav button
                document.querySelectorAll('.nav-button').forEach(button => {
                    button.classList.toggle('active', button.dataset.screen === screenName);
                });
                
                // Clear main content
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = '';
                
                // Render the new screen
                switch (screenName) {
                    case 'home':
                        this.renderHomeScreen();
                        break;
                    case 'camera':
                        this.renderCameraScreen();
                        break;
                    case 'drawing':
                        this.renderDrawingScreen();
                        break;
                    case 'puzzle':
                        this.renderPuzzleScreen();
                        break;
                    case 'gallery':
                        this.renderGalleryScreen();
                        break;
                }
            },
            
            // Home Screen
            renderHomeScreen() {
                const mainContent = document.getElementById('main-content');
                
                const homeContainer = document.createElement('div');
                homeContainer.className = 'home-container';
                
                const homeTitle = document.createElement('h2');
                homeTitle.className = 'home-title';
                homeTitle.textContent = 'Welcome to Animal Art Adventure!';
                
                const featureGrid = document.createElement('div');
                featureGrid.className = 'feature-grid';
                
                // Define the features
                const features = [
                    { icon: '📷', title: 'Take Photos', color: '#FED7E2', screen: 'camera' },
                    { icon: '🎨', title: 'Draw Animals', color: '#C3DAFE', screen: 'drawing' },
                    { icon: '🧩', title: 'Make Puzzles', color: '#C6F6D5', screen: 'puzzle' },
                    { icon: '📱', title: 'My Gallery', color: '#FEEBC8', screen: 'gallery' }
                ];
                
                // Create the feature cards
                features.forEach(feature => {
                    const card = document.createElement('div');
                    card.className = 'feature-card';
                    card.style.backgroundColor = feature.color;
                    card.addEventListener('click', () => this.navigateToScreen(feature.screen));
                    
                    const icon = document.createElement('div');
                    icon.className = 'feature-icon';
                    icon.textContent = feature.icon;
                    
                    const title = document.createElement('div');
                    title.className = 'feature-title';
                    title.textContent = feature.title;
                    
                    card.appendChild(icon);
                    card.appendChild(title);
                    featureGrid.appendChild(card);
                });
                
                homeContainer.appendChild(homeTitle);
                homeContainer.appendChild(featureGrid);
                mainContent.appendChild(homeContainer);
            },
            
            // Camera Screen
            renderCameraScreen() {
                const mainContent = document.getElementById('main-content');
                
                const cameraContainer = document.createElement('div');
                cameraContainer.className = 'camera-container';
                
                const title = document.createElement('h2');
                title.textContent = 'Capture Animals!';
                title.style.color = '#805AD5';
                title.style.fontSize = '20px';
                
                const viewfinder = document.createElement('div');
                viewfinder.className = 'viewfinder';
                
                const cameraView = document.createElement('video');
                cameraView.id = 'camera-view';
                cameraView.autoplay = true;
                cameraView.playsInline = true; // Important for iOS
                
                const viewfinderFrame = document.createElement('div');
                viewfinderFrame.className = 'viewfinder-frame';
                
                viewfinder.appendChild(cameraView);
                viewfinder.appendChild(viewfinderFrame);
                
                const cameraControls = document.createElement('div');
                cameraControls.className = 'camera-controls';
                
                const galleryButton = document.createElement('button');
                galleryButton.className = 'camera-button small';
                galleryButton.innerHTML = '🖼️';
                galleryButton.addEventListener('click', () => this.navigateToScreen('gallery'));
                
                const captureButton = document.createElement('button');
                captureButton.className = 'camera-button capture';
                captureButton.innerHTML = '📷';
                captureButton.addEventListener('click', () => this.capturePhoto());
                
                const switchButton = document.createElement('button');
                switchButton.className = 'camera-button small';
                switchButton.innerHTML = '🔄';
                switchButton.addEventListener('click', () => this.toggleCamera());
                
                cameraControls.appendChild(galleryButton);
                cameraControls.appendChild(captureButton);
                cameraControls.appendChild(switchButton);
                
                const helpText = document.createElement('p');
                helpText.textContent = 'Find an animal and take its picture!';
                helpText.style.textAlign = 'center';
                helpText.style.color = '#805AD5';
                helpText.style.fontSize = '14px';
                
                cameraContainer.appendChild(title);
                cameraContainer.appendChild(viewfinder);
                cameraContainer.appendChild(cameraControls);
                cameraContainer.appendChild(helpText);
                
                mainContent.appendChild(cameraContainer);
                
                // Start the camera
                this.startCamera();
            },
            
            startCamera() {
                // Access the device camera
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    })
                    .then(stream => {
                        const video = document.getElementById('camera-view');
                        if (video) {
                            this.cameraStream = stream;
                            video.srcObject = stream;
                        }
                    })
                    .catch(error => {
                        console.error('Camera error:', error);
                        alert('Could not access the camera. Please make sure you have given permission.');
                    });
                } else {
                    alert('Sorry, your browser does not support camera access.');
                }
            },
            
            stopCamera() {
                // Stop the camera stream
                if (this.cameraStream) {
                    this.cameraStream.getTracks().forEach(track => {
                        track.stop();
                    });
                    this.cameraStream = null;
                }
            },
            
            toggleCamera() {
                // Toggle between front and rear cameras
                this.stopCamera();
                
                const facingMode = this.cameraStream ? 
                    (this.cameraStream.getVideoTracks()[0].getSettings().facingMode === 'environment' ? 'user' : 'environment') : 
                    'environment';
                
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: facingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                })
                .then(stream => {
                    const video = document.getElementById('camera-view');
                    if (video) {
                        this.cameraStream = stream;
                        video.srcObject = stream;
                    }
                })
                .catch(error => {
                    console.error('Camera switch error:', error);
                });
            },
            
            capturePhoto() {
                const video = document.getElementById('camera-view');
                if (!video || !this.cameraStream) return;
                
                // Create a canvas to capture the photo
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Get the image as data URL
                const imageDataUrl = canvas.toDataURL('image/jpeg');
                
                // Add to photos array
                this.photos.unshift({
                    src: imageDataUrl,
                    thumbnail: imageDataUrl,
                    timestamp: Date.now()
                });
                
                // Show capture animation
                const viewfinder = document.querySelector('.viewfinder');
                if (viewfinder) {
                    viewfinder.style.transition = 'opacity 0.1s';
                    viewfinder.style.opacity = '0.5';
                    setTimeout(() => {
                        viewfinder.style.opacity = '1';
                    }, 100);
                }
                
                // Optionally navigate to gallery or drawing
                setTimeout(() => {
                    if (confirm('Great photo! Do you want to draw on it?')) {
                        this.navigateToScreen('drawing');
                    }
                }, 300);
            },
            
            // Drawing Screen
            renderDrawingScreen() {
                const mainContent = document.getElementById('main-content');
                
                const drawingContainer = document.createElement('div');
                drawingContainer.className = 'drawing-container';
                
                const title = document.createElement('h2');
                title.textContent = 'Drawing Studio';
                title.style.color = '#805AD5';
                title.style.fontSize = '20px';
                
                // Create canvas for drawing
                const canvasContainer = document.createElement('div');
                canvasContainer.style.width = '100%';
                
                const canvas = document.createElement('canvas');
                canvas.id = 'drawing-canvas';
                canvas.width = 800;
                canvas.height = 800;
                
                canvasContainer.appendChild(canvas);
                
                // Color palette
                const colorPalette = document.createElement('div');
                colorPalette.className = 'color-palette';
                
                this.colors.forEach((colorObj, index) => {
                    const colorButton = document.createElement('button');
                    colorButton.className = `color-button ${colorObj.active ? 'active' : ''}`;
                    colorButton.style.backgroundColor = colorObj.color;
                    colorButton.dataset.color = colorObj.color;
                    colorButton.addEventListener('click', () => this.selectColor(index));
                    colorPalette.appendChild(colorButton);
                });
                
                // Drawing tools
                const drawingTools = document.createElement('div');
                drawingTools.className = 'drawing-tools';
                
                this.tools.forEach((tool, index) => {
                    const toolButton = document.createElement('button');
                    toolButton.className = `tool-button ${tool.active ? 'active' : ''}`;
                    toolButton.textContent = tool.icon;
                    toolButton.dataset.tool = tool.id;
                    toolButton.addEventListener('click', () => this.selectTool(index));
                    drawingTools.appendChild(toolButton);
                });
                
                // Templates row
                const templatesRow = document.createElement('div');
                templatesRow.className = 'templates-row';
                
                this.templates.forEach(template => {
                    const templateItem = document.createElement('div');
                    templateItem.className = 'template-item';
                    
                    const templateIcon = document.createElement('div');
                    templateIcon.className = 'template-icon';
                    templateIcon.textContent = template.icon;
                    
                    const templateLabel = document.createElement('div');
                    templateLabel.className = 'template-label';
                    templateLabel.textContent = template.label;
                    
                    templateItem.appendChild(templateIcon);
                    templateItem.appendChild(templateLabel);
                    templateItem.addEventListener('click', () => this.addTemplate(template));
                    
                    templatesRow.appendChild(templateItem);
                });
                
                // Clear and Save buttons
                const actionButtons = document.createElement('div');
                actionButtons.className = 'action-buttons';
                
                const clearButton = document.createElement('button');
                clearButton.className = 'action-button';
                clearButton.innerHTML = '🗑️ Clear';
                clearButton.addEventListener('click', () => this.clearCanvas());
                
                const saveButton = document.createElement('button');
                saveButton.className = 'action-button';
                saveButton.innerHTML = '💾 Save';
                saveButton.addEventListener('click', () => this.saveDrawing());
                
                actionButtons.appendChild(clearButton);
                actionButtons.appendChild(saveButton);
                
                // Add all elements to container
                drawingContainer.appendChild(title);
                drawingContainer.appendChild(canvasContainer);
                drawingContainer.appendChild(colorPalette);
                drawingContainer.appendChild(drawingTools);
                drawingContainer.appendChild(templatesRow);
                drawingContainer.appendChild(actionButtons);
                
                mainContent.appendChild(drawingContainer);
                
                // Initialize the canvas
                this.initDrawingCanvas();
            },
            
            initDrawingCanvas() {
                const canvas = document.getElementById('drawing-canvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                
                // Set white background
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // If we're editing the last taken photo
                if (this.photos.length > 0 && this.currentScreen === 'drawing') {
                    const img = new Image();
                    img.onload = () => {
                        // Draw the image centered and scaled to fit
                        const scale = Math.min(canvas.width / img.width, canvas.height / img.height) * 0.9;
                        const x = (canvas.width - img.width * scale) / 2;
                        const y = (canvas.height - img.height * scale) / 2;
                        
                        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                    };
                    img.src = this.photos[0].src;
                }
                
                // Set up drawing events
                canvas.addEventListener('mousedown', this.startDrawing.bind(this));
                canvas.addEventListener('mousemove', this.draw.bind(this));
                canvas.addEventListener('mouseup', this.stopDrawing.bind(this));
                canvas.addEventListener('mouseout', this.stopDrawing.bind(this));
                
                // Touch events for mobile
                canvas.addEventListener('touchstart', this.startDrawingTouch.bind(this));
                canvas.addEventListener('touchmove', this.drawTouch.bind(this));
                canvas.addEventListener('touchend', this.stopDrawing.bind(this));
            },
            
            startDrawing(e) {
                this.isDrawing = true;
                this.lastX = e.offsetX;
                this.lastY = e.offsetY;
            },
            
            startDrawingTouch(e) {
                e.preventDefault();
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    const canvas = document.getElementById('drawing-canvas');
                    const rect = canvas.getBoundingClientRect();
                    this.lastX = touch.clientX - rect.left;
                    this.lastY = touch.clientY - rect.top;
                    this.isDrawing = true;
                }
            },
            
            draw(e) {
                if (!this.isDrawing) return;
                
                const canvas = document.getElementById('drawing-canvas');
                const ctx = canvas.getContext('2d');
                
                if (this.currentTool === 'brush') {
                    ctx.strokeStyle = this.currentColor;
                    ctx.lineWidth = 5;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    
                    ctx.beginPath();
                    ctx.moveTo(this.lastX, this.lastY);
                    ctx.lineTo(e.offsetX, e.offsetY);
                    ctx.stroke();
                    
                    this.lastX = e.offsetX;
                    this.lastY = e.offsetY;
                } else if (this.currentTool === 'stamp') {
                    // Simple stamp tool
                    ctx.fillStyle = this.currentColor;
                    ctx.beginPath();
                    ctx.arc(e.offsetX, e.offsetY, 15, 0, Math.PI * 2);
                    ctx.fill();
                }
            },
            
            drawTouch(e) {
                e.preventDefault();
                if (!this.isDrawing || e.touches.length !== 1) return;
                
                const touch = e.touches[0];
                const canvas = document.getElementById('drawing-canvas');
                const rect = canvas.getBoundingClientRect();
                const offsetX = touch.clientX - rect.left;
                const offsetY = touch.clientY - rect.top;
                
                const ctx = canvas.getContext('2d');
                
                if (this.currentTool === 'brush') {
                    ctx.strokeStyle = this.currentColor;
                    ctx.lineWidth = 5;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    
                    ctx.beginPath();
                    ctx.moveTo(this.lastX, this.lastY);
                    ctx.lineTo(offsetX, offsetY);
                    ctx.stroke();
                    
                    this.lastX = offsetX;
                    this.lastY = offsetY;
                } else if (this.currentTool === 'stamp') {
                    // Simple stamp tool
                    ctx.fillStyle = this.currentColor;
                    ctx.beginPath();
                    ctx.arc(offsetX, offsetY, 15, 0, Math.PI * 2);
                    ctx.fill();
                }
            },
            
            stopDrawing() {
                this.isDrawing = false;
            },
            
            selectColor(index) {
                // Update active color
                this.colors.forEach((colorObj, i) => {
                    colorObj.active = (i === index);
                });
                this.currentColor = this.colors[index].color;
                
                // Update UI
                const colorButtons = document.querySelectorAll('.color-button');
                colorButtons.forEach((button, i) => {
                    button.classList.toggle('active', i === index);
                });
            },
            
            selectTool(index) {
                // Update active tool
                this.tools.forEach((tool, i) => {
                    tool.active = (i === index);
                });
                this.currentTool = this.tools[index].id;
                
                // Update UI
                const toolButtons = document.querySelectorAll('.tool-button');
                toolButtons.forEach((button, i) => {
                    button.classList.toggle('active', i === index);
                });
            },
            
            addTemplate(template) {
                const canvas = document.getElementById('drawing-canvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                
                // Draw a template icon at the center
                ctx.font = '60px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(template.icon, canvas.width / 2, canvas.height / 2);
            },
            
            clearCanvas() {
                const canvas = document.getElementById('drawing-canvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            },
            
            saveDrawing() {
                const canvas = document.getElementById('drawing-canvas');
                if (!canvas) return;
                
                // Get the image as data URL
                const imageDataUrl = canvas.toDataURL('image/png');
                
                // Add to drawings array
                this.drawings.unshift({
                    src: imageDataUrl,
                    thumbnail: imageDataUrl,
                    timestamp: Date.now()
                });
                
                alert('Drawing saved! You can find it in your gallery.');
            },
            
            // Puzzle Screen
            renderPuzzleScreen() {
                const mainContent = document.getElementById('main-content');
                
                const puzzleContainer = document.createElement('div');
                puzzleContainer.className = 'puzzle-container';
                
                const title = document.createElement('h2');
                title.textContent = 'Puzzle Creator';
                title.style.color = '#805AD5';
                title.style.fontSize = '20px';
                
                // Image selection section
                const selectionSection = document.createElement('div');
                selectionSection.className = 'selection-section';
                
                const imageLabel = document.createElement('p');
                imageLabel.textContent = 'Select an image for your puzzle:';
                imageLabel.style.color = '#805AD5';
                imageLabel.style.fontSize = '14px';
                
                const puzzleImages = document.createElement('div');
                puzzleImages.className = 'puzzle-images';
                
                // Combine photos and drawings for puzzle creation
                const allImages = [...this.photos, ...this.drawings];
                
                allImages.slice(0, 6).forEach((image, index) => {
                    const puzzleImage = document.createElement('div');
                    puzzleImage.className = `puzzle-image ${this.selectedPuzzleImage === index ? 'active' : ''}`;
                    puzzleImage.addEventListener('click', () => this.selectPuzzleImage(index));
                    
                    const img = document.createElement('img');
                    img.src = image.thumbnail || image.src;
                    img.alt = 'Puzzle image';
                    
                    puzzleImage.appendChild(img);
                    puzzleImages.appendChild(puzzleImage);
                });
                
                selectionSection.appendChild(imageLabel);
                selectionSection.appendChild(puzzleImages);
                
                // Difficulty selection
                const difficultySection = document.createElement('div');
                difficultySection.className = 'difficulty-section';
                
                const difficultyLabel = document.createElement('p');
                difficultyLabel.textContent = 'Choose puzzle difficulty:';
                difficultyLabel.style.color = '#805AD5';
                difficultyLabel.style.fontSize = '14px';
                
                const difficultyButtons = document.createElement('div');
                difficultyButtons.className = 'difficulty-buttons';
                
                const easyButton = document.createElement('button');
                easyButton.className = `difficulty-button ${this.puzzleDifficulty === 'easy' ? 'active' : ''}`;
                easyButton.textContent = 'Easy (4 pieces)';
                easyButton.addEventListener('click', () => this.setPuzzleDifficulty('easy'));
                
                const mediumButton = document.createElement('button');
                mediumButton.className = `difficulty-button ${this.puzzleDifficulty === 'medium' ? 'active' : ''}`;
                mediumButton.textContent = 'Medium (9 pieces)';
                mediumButton.addEventListener('click', () => this.setPuzzleDifficulty('medium'));
                
                difficultyButtons.appendChild(easyButton);
                difficultyButtons.appendChild(mediumButton);
                
                difficultySection.appendChild(difficultyLabel);
                difficultySection.appendChild(difficultyButtons);
                
                // Puzzle preview
                const puzzlePreview = document.createElement('div');
                puzzlePreview.className = 'puzzle-preview';
                
                if (this.selectedPuzzleImage !== null && allImages[this.selectedPuzzleImage]) {
                    const puzzleGrid = document.createElement('div');
                    puzzleGrid.className = `puzzle-grid ${this.puzzleDifficulty}`;
                    
                    const pieces = this.puzzleDifficulty === 'easy' ? 4 : 9;
                    
                    for (let i = 0; i < pieces; i++) {
                        const puzzlePiece = document.createElement('div');
                        puzzlePiece.className = 'puzzle-piece';
                        puzzleGrid.appendChild(puzzlePiece);
                    }
                    
                    puzzlePreview.appendChild(puzzleGrid);
                } else {
                    const placeholderText = document.createElement('div');
                    placeholderText.style.width = '100%';
                    placeholderText.style.height = '100%';
                    placeholderText.style.display = 'flex';
                    placeholderText.style.alignItems = 'center';
                    placeholderText.style.justifyContent = 'center';
                    placeholderText.style.color = '#CBD5E0';
                    placeholderText.textContent = 'Select an image to create a puzzle!';
                    
                    puzzlePreview.appendChild(placeholderText);
                }
                
                // Create button
                const createButton = document.createElement('button');
                createButton.className = 'create-button';
                createButton.textContent = 'Create My Puzzle!';
                createButton.disabled = this.selectedPuzzleImage === null;
                createButton.addEventListener('click', () => this.createPuzzle());
                
                // Add all sections to container
                puzzleContainer.appendChild(title);
                puzzleContainer.appendChild(selectionSection);
                puzzleContainer.appendChild(difficultySection);
                puzzleContainer.appendChild(puzzlePreview);
                puzzleContainer.appendChild(createButton);
                
                mainContent.appendChild(puzzleContainer);
            },
            
            selectPuzzleImage(index) {
                this.selectedPuzzleImage = index;
                this.navigateToScreen('puzzle'); // Refresh the screen
            },
            
            setPuzzleDifficulty(difficulty) {
                this.puzzleDifficulty = difficulty;
                this.navigateToScreen('puzzle'); // Refresh the screen
            },
            
            createPuzzle() {
                // In a real app, this would create an interactive puzzle
                // For this demo, we'll just show a success message
                alert('Puzzle created! You can now play with it.');
                
                // In a real implementation, you would:
                // 1. Create a canvas with the selected image
                // 2. Divide it into pieces based on difficulty
                // 3. Randomize piece positions
                // 4. Create an interactive drag-and-drop puzzle game
            },
            
            // Gallery Screen
            renderGalleryScreen() {
                const mainContent = document.getElementById('main-content');
                
                const galleryContainer = document.createElement('div');
                galleryContainer.className = 'gallery-container';
                
                const title = document.createElement('h2');
                title.textContent = 'My Gallery';
                title.style.color = '#805AD5';
                title.style.fontSize = '20px';
                
                // Grid of images
                const galleryGrid = document.createElement('div');
                galleryGrid.className = 'gallery-grid';
                
                // Combine photos and drawings for display
                const allItems = [...this.photos, ...this.drawings];
                
                if (allItems.length === 0) {
                    const emptyMessage = document.createElement('p');
                    emptyMessage.textContent = 'Your gallery is empty. Take some photos or create drawings!';
                    emptyMessage.style.textAlign = 'center';
                    emptyMessage.style.color = '#805AD5';
                    galleryContainer.appendChild(emptyMessage);
                } else {
                    allItems.forEach((item, index) => {
                        const galleryItem = document.createElement('div');
                        galleryItem.className = 'gallery-item';
                        
                        const img = document.createElement('img');
                        img.className = 'gallery-image';
                        img.src = item.thumbnail || item.src;
                        img.alt = 'Gallery item';
                        
                        const overlay = document.createElement('div');
                        overlay.className = 'gallery-overlay';
                        
                        galleryItem.appendChild(img);
                        galleryItem.appendChild(overlay);
                        galleryItem.addEventListener('click', () => this.viewGalleryItem(index));
                        
                        galleryGrid.appendChild(galleryItem);
                    });
                }
                
                // Action buttons
                const actionButtons = document.createElement('div');
                actionButtons.className = 'action-buttons';
                
                const saveButton = document.createElement('button');
                saveButton.className = 'action-button';
                saveButton.innerHTML = '💾 Save';
                saveButton.addEventListener('click', () => this.saveAllToDevice());
                
                const printButton = document.createElement('button');
                printButton.className = 'action-button';
                printButton.innerHTML = '🖨️ Print';
                printButton.addEventListener('click', () => this.printGallery());
                
                const shareButton = document.createElement('button');
                shareButton.className = 'action-button';
                shareButton.innerHTML = '📤 Share';
                shareButton.addEventListener('click', () => this.shareGallery());
                
                actionButtons.appendChild(saveButton);
                actionButtons.appendChild(printButton);
                actionButtons.appendChild(shareButton);
                
                // Add all sections to container
                galleryContainer.appendChild(title);
                galleryContainer.appendChild(galleryGrid);
                galleryContainer.appendChild(actionButtons);
                
                mainContent.appendChild(galleryContainer);
            },
            
            viewGalleryItem(index) {
                // In a real app, this would open a fullscreen view
                const allItems = [...this.photos, ...this.drawings];
                
                if (allItems[index]) {
                    // Create a modal to view the image
                    const modal = document.createElement('div');
                    modal.style.position = 'fixed';
                    modal.style.top = '0';
                    modal.style.left = '0';
                    modal.style.width = '100%';
                    modal.style.height = '100%';
                    modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
                    modal.style.display = 'flex';
                    modal.style.alignItems = 'center';
                    modal.style.justifyContent = 'center';
                    modal.style.zIndex = '9999';
                    
                    const img = document.createElement('img');
                    img.src = allItems[index].src;
                    img.style.maxWidth = '90%';
                    img.style.maxHeight = '90%';
                    img.style.objectFit = 'contain';
                    
                    modal.appendChild(img);
                    document.body.appendChild(modal);
                    
                    // Close modal when clicked
                    modal.addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });
                }
            },
            
            saveAllToDevice() {
                alert('On a real device, this would save all images to your photo library!');
                // In a real app, this would use the device's file system API
            },
            
            printGallery() {
                alert('On a real device, this would open the print dialog!');
                // In a real app, this would use the device's print API
            },
            
            shareGallery() {
                alert('On a real device, this would open sharing options!');
                // In a real app, this would use the Web Share API
            }
        };
        
        // Start the app when the page loads
        window.addEventListener('load', () => {
            app.init();
        });
    </script>
</body>
</html>
